<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>fnf reader</title>
    <link rel="stylesheet" href="../clickable.css">
    <style>
        /*img {
            max-width: 500px;
        }*/
        .leftArrow.left {
            position: absolute;
            clip: rect(0px,153px,153px,0px);
            left:0;

        }
        .downArrow.left {
            position: absolute;
            clip: rect(0px,309px,154px,153px);
            left: 10px;
        }
        .upArrow.left {
            position: absolute;
            clip: rect(0px,465px,153px,310px);
            left: 20px;
        }
        .rightArrow.left {
            position: absolute;
            clip: rect(0px,620px,153px,465px);
            left: 30px;
        }
        
        
        .leftArrow.right {
            position: absolute;
            clip: rect(0px,153px,153px,0px);
            right:30px;
        }
        .downArrow.right {
            position: absolute;
            clip: rect(0px,309px,154px,153px);
            right: 20px;
        }
        .upArrow.right {
            position: absolute;
            clip: rect(0px,465px,153px,310px);
            right: 10px;
        }
        .rightArrow.right {
            position: absolute;
            clip: rect(0px,620px,153px,465px);
            right: 0px;
        }
    </style>
    <script src="../oof.js"></script>
    <script src="foolhardy.json"></script>
    <script src="whereareyou.json"></script>
    <script src="furiosity.json"></script>
    <script src="supernovae.json"></script>
    <script src="hellclown.json"></script>
    <script src="bushwhack.json"></script>
    <script src="boxingmatch.json"></script>
</head>
<body style="width:100%;height:100%;overflow:hidden;">
    <center>
        <form style="display: inline-block;" id="forme">
            <select onchange="this.parentElement.children[1].value = eval(`JSON.parse(${this.value}).song.speed`)">
                <option value="whereareyou">shaggy where are you</option>
                <option value="foolhardy">foolhardy</option>
                <option value="furiosity">vs dave furiosity</option>
                <option value="supernovae">vs dave supernovae</option>
                <option value="bushwhack">zardy bushwhack</option>
                <option value="hellclown">tricky hellclown</option>
                <option value="boxingmatch">matt boxing match</option>
            </select>
            <input type="number" step=".1" onblur="this.value = this.value == '' ? eval(`JSON.parse(${this.parentElement.firstElementChild.value}).song.speed`) : this.value" value="1.7000000000000002">
            <button type="submit" style="display: block;width: 100%;">Start</button>
        </form>
        <h1 id="combo" style="display: none;">Combo: 0</h1>
        <h1 id="score" style="display: none;">Score: 0</h1>
    </center>
    <img src="../img/fnf arrows.png" class="leftArrow left" style="top: 80%">
    <img src="../img/fnf arrows.png" class="downArrow left" style="top: 80%">
    <img src="../img/fnf arrows.png" class="upArrow left" style="top: 80%">
    <img src="../img/fnf arrows.png" class="rightArrow left" style="top: 80%">


    <img src="../img/fnf arrows.png" class="leftArrow right" style="top: 80%">
    <img src="../img/fnf arrows.png" class="downArrow right" style="top: 80%">
    <img src="../img/fnf arrows.png" class="upArrow right" style="top: 80%">
    <img src="../img/fnf arrows.png" class="rightArrow right" style="top: 80%">

    <script>
        var started = false;
        var paused = false;
        var music;
        var song;
        var songSpeed;
        var animationFrame;
        var comboNumber = 0;
        var notesArray = [];
        var couldHitNotes = [[],[],[],[]];
        var keys = {};
        var notesMap = new Map();
        notesMap.set(0,"leftArrow");
        notesMap.set(1,"downArrow");
        notesMap.set(2,"upArrow");
        notesMap.set(3,"rightArrow");
        
        /*document.addEventListener("click",()=> {
            if(!started) {
                start();
            }
            started = true;
        });*/
        function goodHit(noteDiff) {
            //replace good with king
            if (noteDiff > 166) { // so god damn early its a miss 
                combo.innerHTML = "Combo: 0 (miss)"; comboNumber = 0;
            }
            if (noteDiff > 135) { // way early
                combo.innerHTML = `Combo: ${++comboNumber} (shit)`;
            }else if (noteDiff > 90) {// early
                combo.innerHTML = `Combo: ${++comboNumber} (bad)`;
            }else if (noteDiff > 45) {// your kinda there
                combo.innerHTML = `Combo: ${++comboNumber} (good)`;
            }else if (noteDiff < 45 && noteDiff > -45) {
                combo.innerHTML = `Combo: ${++comboNumber} (great)`;
                console.log(comboNumber);
            }else if (noteDiff < -45) {// little late
                combo.innerHTML = `Combo: ${++comboNumber} (good)`;
            }else if (noteDiff < -90) {// late
                combo.innerHTML = `Combo: ${++comboNumber} (bad)`;
            }else if (noteDiff < -135) {// late as fuck
                combo.innerHTML = `Combo: ${++comboNumber} (shit)`;
            }else if (noteDiff < -166) {// so god damn late its a miss
                combo.innerHTML = "Combo: 0 (miss)";
                comboNumber = 0;
            }
                console.log(noteDiff);
        }
        function noteInRow(row) {
            //couldHitNotes[row][0].htmlObj.src = "../img/colored fnf arrows.png";
            //couldHitNotes[row][couldHitNotes[row].length-1].htmlObj.src = "../img/colored fnf arrows.png";

            /*couldHitNotes[row].forEach((note) => {
                let bruh = note.mili+(song.startTime - new Date().getTime());
                
            });*/
            try {
                couldHitNotes[row].sort((note, note2) => (note.mili+(song.startTime - new Date().getTime()) > note2.mili+(song.startTime - new Date().getTime())) ? 1 : -1);
                let note = couldHitNotes[row][0];
                let noteDiff = note.mili+(song.startTime - new Date().getTime());
                goodHit(noteDiff);
                //couldHitNotes[row][0].htmlObj.src = "../img/colored fnf arrows.png";
                notesArray.splice(notesArray.indexOf(note),1);
                couldHitNotes[row].splice(0,1);
                note.htmlObj.remove();
            }catch {

            }
        }
        document.addEventListener("keydown",(event)=>{
            if(event.key == "-") {
                music.sound.volume -= .1;
            }else if(event.key == "+" || event.key == "=") {
                music.sound.volume += .1;
            }
            if(event.key == "Enter") {
                new sound("../sounds/textclickmodern.ogg").play();
                if(!paused) { //have to negate this value because im setting it after (because i need the start time)
                    music.sound.pause();
                    cancelAnimationFrame(animationFrame);
                }else {
                    music.sound.play();
                    song.startTime += new Date().getTime()-paused;
                    tick();
                }
                paused = paused == false ? new Date().getTime() : false;
            }
            if(!keys[event.key]) {
                //console.log(keys[event.key]);
                if(event.key == "d" || event.key == "ArrowLeft") {
                    document.getElementsByClassName("leftArrow right")[0].src = "../img/colored fnf arrows.png";
                    noteInRow(0);
                }
                if(event.key == "f" || event.key == "ArrowDown") {
                    document.getElementsByClassName("downArrow right")[0].src = "../img/colored fnf arrows.png";
                    noteInRow(1);
                }
                if(event.key == "j" || event.key == "ArrowUp") {
                    document.getElementsByClassName("upArrow right")[0].src = "../img/colored fnf arrows.png";
                    noteInRow(2);
                }
                if(event.key == "k" || event.key == "ArrowRight") {
                    document.getElementsByClassName("rightArrow right")[0].src = "../img/colored fnf arrows.png";
                    noteInRow(3);
                }
            }
            keys[event.key] = true; 
        });
        document.addEventListener("keyup",(event)=>{
            if(event.key == "d" || event.key == "ArrowLeft") {
                document.getElementsByClassName("leftArrow right")[0].src = "../img/fnf arrows.png";
            }
            if(event.key == "f" || event.key == "ArrowDown") {
                document.getElementsByClassName("downArrow right")[0].src = "../img/fnf arrows.png";
            }
            if(event.key == "j" || event.key == "ArrowUp") {
                document.getElementsByClassName("upArrow right")[0].src = "../img/fnf arrows.png";
            }
            if(event.key == "k" || event.key == "ArrowRight") {
                document.getElementsByClassName("rightArrow right")[0].src = "../img/fnf arrows.png";
            }
            delete keys[event.key];
        })
        function noteObj(mili,note,left,hold) {
            this.mili = mili;
            if(!left) {
                this.mustHit = true;
                this.row = note;
            }
            this.createNote = ()=>{
                this.htmlObj = document.createElement('img');
                this.htmlObj.src = "../img/colored fnf arrows.png";
                this.htmlObj.style.display = "none";
                this.htmlObj.className = notesMap.get(note) + " " + (this.mustHit ? "right" : "left");
                //this.htmlObj.parentElement = document.body;
                this.htmlObj = document.body.appendChild(this.htmlObj);
            }
        }
        function tick() {
            notesArray.forEach(note => {
                let shit = note.mili+(song.startTime - new Date().getTime());
                if(shit < 2500 && !note.htmlObj) {
                    note.createNote();
                }else if(shit < 2500) {
                    note.htmlObj.style.display = "inline";                                                                                                                                                                                        
                    //console.log(song.startTime - new Date().getTime());
                    //console.log(note.mili - (song.startTime - new Date().getTime()));
                    note.htmlObj.style.top = "calc(80% - " + (shit*songSpeed) + "px)";
                    //note.htmlObj.style.top = "calc(50% - " + toString((note.mili/100)) + "px)";
                    if(shit < 1000) {
                        if(note.mustHit && couldHitNotes[note.row].indexOf(note) == -1) {
                            //note.htmlObj.src = "../img/fnf arrows.png";
                            couldHitNotes[note.row].push(note);
                        }
                    }
                    if(shit <= 0 && !note.mustHit) {
                        notesArray.splice(notesArray.indexOf(note),1);
                        note.htmlObj.remove();
                    }else if(shit <= -200) {
                        notesArray.splice(notesArray.indexOf(note),1);
                        couldHitNotes[note.row].splice(couldHitNotes[note.row].indexOf(note),1);
                        note.htmlObj.remove();
                        goodHit(1000); //(miss)
                        //del(htmlObj,document.body);
                    }
                }
            });
            //notesArray[0].htmlObj.src = "../img/fnf arrows.png";
            animationFrame = requestAnimationFrame(tick);
        }
        forme.onsubmit = (event) => {
            event.preventDefault();
            let songName = forme.firstElementChild.value;
            //console.log(songName);
            //console.log(JSON.parse(songName));
            music = new sound(songName+".mp3");
            song = JSON.parse(eval(songName)).song;
            songSpeed = forme.children[1].value/2;
            forme.remove();
            combo.style.display = "block";
            score.style.display = "block";
            delete foolhardy;
            delete whereareyou;
            delete furiosity;
            delete supernovae;
            delete hellclown;
            delete bushwhack;
            delete boxingmatch;//Wake up get up get put there
            //let letsgo = false;
            //music.play();

            //music.sound.onload = function() {
            
            music.sound.addEventListener("loadeddata",function() {
                //letsgo = true;
                console.log(music.sound.readyState);
                if(music.sound.readyState == 4) {
                    song.startTime = new Date().getTime();
                    
                    music.play();

                    song.notes.forEach(bruh => {
                        bruh.sectionNotes.forEach(notes => {
                            //console.log(notes);
                            if(notes[1] < 4) {
                                notesArray.push(new noteObj(notes[0],notes[1],!bruh.mustHitSection,notes[2] == 0 ? true : false));
                            }else {
                                notesArray.push(new noteObj(notes[0],notes[1]%4,bruh.mustHitSection,notes[2] == 0 ? true : false));
                            }
                        });
                    });

                    tick();
                }
                //setInterval(()=> {
                    
                //},1);
            });
            //let shit = setInterval(()=> { (yeah ok i realize this looks horrible so im gonna try to use a promise (i literally didn't have to do any of this (i thought i had to because i was gonna combine the voices and the background music but i decided it was dumb,)))
                //if(letsgo) {
                    
                    //clearInterval(shit);
                //}
            //},1)
        }
        //function start() {
            
        //}
        //console.log(song);
    </script>
</body>
</html>